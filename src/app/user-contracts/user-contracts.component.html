<div class="container">
    <div class="header-actions">
      <button mat-stroked-button color="primary" (click)="onBack()" class="back-button">
        <mat-icon>arrow_back_ios</mat-icon> Retour à l'accueil
      </button>
    </div>
    
    <div class="filter-container">
        <div class="filters-row">
            <mat-form-field appearance="outline" class="search-field">
                <mat-label>Rechercher un contrat</mat-label>
                    <input matInput [formControl]="searchFilter" placeholder="Rechercher par entreprise, contrat..." #input>
                    <mat-icon matSuffix>search</mat-icon>
                </mat-form-field>
                
                    <mat-form-field appearance="outline" class="year-filter">
                        <mat-label>Année</mat-label>
                        <mat-select [formControl]="yearFilter">
                            <mat-option [value]="null">Toutes</mat-option>
                            <mat-option *ngFor="let year of years" [value]="year">{{year}}</mat-option>
                        </mat-select>
                        <button mat-icon-button matSuffix (click)="clearYearFilter()" *ngIf="yearFilter.value">
                            <mat-icon>close</mat-icon>
                        </button>
                    </mat-form-field>
                    
                    <mat-form-field appearance="outline" class="validation-filter">
                        <mat-label>Validé</mat-label>
                        <mat-select [formControl]="validationFilter">
                            <mat-option [value]="null">Tous</mat-option>
                            <mat-option [value]="'true'">Oui</mat-option>
                            <mat-option [value]="'false'">Non</mat-option>
                        </mat-select>
                        <button mat-icon-button matSuffix (click)="clearValidationFilter()" *ngIf="validationFilter.value !== null">
                            <mat-icon>close</mat-icon>
                        </button>
                    </mat-form-field>
            </div>
        </div>

    <div class="table-container" [class.mobile-view]="isMobileView()">
        <table mat-table [dataSource]="dataSource" class="mat-elevation-z1">
            <ng-container matColumnDef="dateAdhesion">
                <th mat-header-cell *matHeaderCellDef>Date de roulage</th>
                <td mat-cell *matCellDef="let element" data-label="Date de roulage">
                    <div class="mat-cell-content">
                        {{element.dateAdhesion | customDate}}
                    </div>
                </td>
            </ng-container>

            <ng-container matColumnDef="dateSaisie">
                <th mat-header-cell *matHeaderCellDef>Date d'effet</th>
                <td mat-cell *matCellDef="let element" data-label="Date d'effet">
                    <div class="mat-cell-content">  
                        {{element.dateSaisie | customDate}}
                    </div>
                </td>
            </ng-container>

            <ng-container matColumnDef="adherentnomCliententreprise">
                <th mat-header-cell *matHeaderCellDef>Entreprise</th>
                <td mat-cell *matCellDef="let element" data-label="Entreprise" class="truncate">
                    <div class="mat-cell-content">
                        {{element.adherentnomCliententreprise}}
                    </div>
                </td>
            </ng-container>

            <ng-container matColumnDef="products">
                <th mat-header-cell *matHeaderCellDef>Contrat</th>
                <td mat-cell *matCellDef="let element" data-label="Produits">
                    <div class="products-container">
                        <ng-container *ngIf="!isMobileView()">
                            <a *ngFor="let product of element.products; trackBy: trackByProductId" 
                               [routerLink]="['/contracts', product.contratID]"
                               class="product-item"
                               [matTooltip]="'Voir les détails du contrat : ' + getProductLabel(product.produitID)"
                               [attr.aria-label]="'Voir les détails du contrat : ' + getProductLabel(product.produitID)">
                                <div class="product-icon-container">
                                    <mat-icon 
                                    class="product-icon"
                                    [class.valid-icon]="product.valide"
                                    [class.invalid-icon]="!product.valide"
                                    [attr.aria-hidden]="true">
                                    {{ getProductIcon(product.produitID) }}
                                  </mat-icon>
                                </div>
                                <span class="product-name"
                                [class.valid-name]="product.valide"
                                [class.invalid-name]="!product.valide">
                                    {{getProductDiminutif(product.produitID)}}
                                </span>
                            </a>
                        </ng-container>
                        <div *ngIf="isMobileView()" class="mobile-products">
                            <a *ngFor="let product of element.products; trackBy: trackByProductId" 
                               [routerLink]="['/contracts', product.contratID]"
                               class="mobile-product-icon"
                               [matTooltip]="'Voir les détails du contrat : ' + getProductLabel(product.produitID)"
                               [attr.aria-label]="'Voir les détails du contrat : ' + getProductLabel(product.produitID)">
                                <mat-icon 
                                    class="product-icon"
                                    [class.valid-icon]="product.valide"
                                    [class.invalid-icon]="!product.valide"
                                    [attr.aria-hidden]="true">
                                    {{getProductIcon(product.produitID)}}
                                </mat-icon>
                            </a>
                        </div>
                    </div>
                </td>
            </ng-container>

            <ng-container matColumnDef="circuit">
                <th mat-header-cell *matHeaderCellDef>Circuit</th>
                <td mat-cell *matCellDef="let element" data-label="Circuit">
                    <div class="mat-cell-content">
                        {{element.circuit || 'N/A'}}
                    </div>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            
            <tr mat-row 
                *matRowDef="let row; columns: displayedColumns;"
                [class.row-valid]="row.allValid"
                [class.row-invalid]="!row.allValid"
                [attr.aria-label]="'Contrat du ' + (row.dateAdhesion | customDate) + ' - Circuit: ' + (row.circuit || 'N/A')">
            </tr>
                
            <tr class="no-data" *matNoDataRow>
                <td [attr.colspan]="displayedColumns.length">
                    <mat-icon>search_off</mat-icon>
                    <span>Aucun contrat ne correspond à votre recherche</span>
                </td>
            </tr>
        </table>
    </div>
    
    <mat-paginator #paginator
                  [pageSizeOptions]="[5, 10, 25, 100]" 
                  [pageSize]="10"
                  [length]="groupedContracts.length"
                  showFirstLastButtons
                  aria-label="Select page of contracts">
    </mat-paginator>
</div>
