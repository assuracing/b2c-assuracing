<div class="container">
    <div class="filter-container">
        <div class="filters-row">
            <mat-form-field appearance="outline" class="search-field">
                <mat-label>Rechercher un contrat</mat-label>
                <input matInput [formControl]="searchFilter" placeholder="Rechercher par entreprise, contrat..." #input>
                <mat-icon matSuffix>search</mat-icon>
            </mat-form-field>
            
                <mat-form-field appearance="outline" class="year-filter">
                    <mat-label>Année</mat-label>
                    <mat-select [formControl]="yearFilter">
                        <mat-option [value]="null">Toutes</mat-option>
                        <mat-option *ngFor="let year of years" [value]="year">{{year}}</mat-option>
                    </mat-select>
                    <button mat-icon-button matSuffix (click)="clearYearFilter()" *ngIf="yearFilter.value">
                        <mat-icon>close</mat-icon>
                    </button>
                </mat-form-field>
                
                <mat-form-field appearance="outline" class="validation-filter">
                    <mat-label>Validé</mat-label>
                    <mat-select [formControl]="validationFilter">
                        <mat-option [value]="null">Tous</mat-option>
                        <mat-option [value]="'true'">Oui</mat-option>
                        <mat-option [value]="'false'">Non</mat-option>
                    </mat-select>
                    <button mat-icon-button matSuffix (click)="clearValidationFilter()" *ngIf="validationFilter.value !== null">
                        <mat-icon>close</mat-icon>
                    </button>
                </mat-form-field>
        </div>
    </div>

    <div class="table-container" [class.mobile-view]="isMobileView()">
        <table mat-table [dataSource]="dataSource" class="mat-elevation-z1">
            <ng-container matColumnDef="dateAdhesion">
                <th mat-header-cell *matHeaderCellDef>Date de roulage</th>
                <td mat-cell *matCellDef="let element" data-label="Date de roulage">
                    <div class="mat-cell-content">
                        {{element.dateAdhesion | customDate}}
                    </div>
                </td>
            </ng-container>

            <ng-container matColumnDef="dateSaisie">
                <th mat-header-cell *matHeaderCellDef>Date d'effet</th>
                <td mat-cell *matCellDef="let element" data-label="Date d'effet">
                    <div class="mat-cell-content">  
                        {{element.dateSaisie | customDate}}
                    </div>
                </td>
            </ng-container>

            <ng-container matColumnDef="adherentnomCliententreprise">
                <th mat-header-cell *matHeaderCellDef>Entreprise</th>
                <td mat-cell *matCellDef="let element" data-label="Entreprise" class="truncate">
                    <div class="mat-cell-content">
                        {{element.adherentnomCliententreprise}}
                    </div>
                </td>
            </ng-container>

            <ng-container matColumnDef="products">
                <th mat-header-cell *matHeaderCellDef>Contrat</th>
                <td mat-cell *matCellDef="let element" data-label="Produits">
                    <div class="products-container">
                        <ng-container *ngIf="!isMobileView()">
                            <div *ngFor="let product of element.products" class="product-item">
                                <div class="product-icon-container">
                                    <mat-icon 
                                    [matTooltip]="getProductLabel(product.nomcontrat)"
                                    class="product-icon"
                                    [class.valid-icon]="product.valide"
                                    [class.invalid-icon]="!product.valide">
                                    {{ getProductIcon(product.nomcontrat) }}
                                  </mat-icon>
                                </div>
                                    <span class="product-name">
                                    {{getProductDiminutif(product.nomcontrat)}}
                                    </span>
                            </div>
                        </ng-container>
                        <div *ngIf="isMobileView()" class="mobile-products">
                            <div *ngFor="let product of element.products" class="mobile-product-icon">
                                <app-adaptive-tooltip [text]="getProductLabel(product.nomcontrat)" [showIcon]="false">
                                    <mat-icon 
                                        class="product-icon"
                                        [class.valid-icon]="product.valide"
                                        [class.invalid-icon]="!product.valide">
                                        {{getProductIcon(product.nomcontrat)}}
                                    </mat-icon>
                                </app-adaptive-tooltip>
                            </div>
                        </div>
                    </div>
                </td>
            </ng-container>

            <ng-container matColumnDef="circuit">
                <th mat-header-cell *matHeaderCellDef>Circuit</th>
                <td mat-cell *matCellDef="let element" data-label="Circuit">
                    <div class="mat-cell-content">
                        {{element.circuit || 'N/A'}}
                    </div>
                </td>
            </ng-container>

            <ng-container matColumnDef="valide">
                <th mat-header-cell *matHeaderCellDef>Validé</th>
                <td mat-cell *matCellDef="let element" data-label="Validé">
                    <div class="mat-cell-content">
                        <span class="status-badge" 
                              [class.valid]="element.allValid" 
                              [class.invalid]="!element.allValid"
                              [attr.aria-label]="element.allValid ? 'Contrat validé' : 'Contrat non validé'">
                            {{element.allValid ? 'Oui' : 'Non'}}
                        </span>
                    </div>
                </td>
            </ng-container>

            <ng-container matColumnDef="actions">
                <th mat-header-cell *matHeaderCellDef>Actions</th>
                <td mat-cell *matCellDef="let element" data-label="Actions">
                    <div class="mat-cell-content">
                        <a mat-icon-button 
                           [routerLink]="['/contracts', element.products[0]?.contratID]" 
                           matTooltip="Voir les détails"
                           aria-label="Voir les détails du contrat">
                            <mat-icon>visibility</mat-icon>
                        </a>
                    </div>
                </td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
            
            <tr mat-row 
                *matRowDef="let row; columns: displayedColumns;"
                [class.row-valid]="row.allValid"
                [class.row-invalid]="!row.allValid"
                [attr.aria-label]="'Contrat du ' + (row.dateAdhesion | customDate) + ' - Circuit: ' + (row.circuit || 'N/A')">
            </tr>
                
            <tr class="no-data" *matNoDataRow>
                <td [attr.colspan]="displayedColumns.length">
                    <mat-icon>search_off</mat-icon>
                    <span>Aucun contrat ne correspond à votre recherche</span>
                </td>
            </tr>
        </table>
    </div>
    
    <mat-paginator #paginator
                  [pageSizeOptions]="[5, 10, 25, 100]" 
                  [pageSize]="10"
                  [length]="groupedContracts.length"
                  showFirstLastButtons
                  aria-label="Select page of contracts">
    </mat-paginator>
</div>
